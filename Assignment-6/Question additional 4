#include<stdio.h>
#include<stdlib.h>

struct Node {
    int data;
    struct Node* next;
    struct Node* prev;
    struct Node* random;  // Random pointer that might be incorrect
};

void correctRandomPointer() {
    printf("Correcting Random Pointer in Doubly Linked List:\n\n");
    
    // Create a doubly linked list: 1<->2<->3<->NULL
    struct Node* head = NULL;
    struct Node* node1 = NULL, *node2 = NULL, *node3 = NULL;
    
    // Create nodes
    node1 = (struct Node*)malloc(sizeof(struct Node));
    node2 = (struct Node*)malloc(sizeof(struct Node));
    node3 = (struct Node*)malloc(sizeof(struct Node));
    
    node1->data = 1;
    node2->data = 2;
    node3->data = 3;
    
    // Set up next pointers
    node1->next = node2;
    node2->next = node3;
    node3->next = NULL;
    
    // Set up prev pointers
    node1->prev = NULL;
    node2->prev = node1;
    node3->prev = node2;
    
    head = node1;
    
    // Display original list
    printf("Original Doubly Linked List:\n");
    struct Node* temp = head;
    while(temp != NULL) {
        printf("Node %d: prev=%s, next=%s\n", 
               temp->data,
               temp->prev ? "node" : "NULL",
               temp->next ? "node" : "NULL");
        temp = temp->next;
    }
    
    // Simulate incorrect random pointer
    // Let's say node2's random pointer incorrectly points to node1
    // but it should point to node3
    node1->random = node2;  // Correct: 1->2
    node2->random = node1;  // Incorrect: 2->1 (should be 2->3)
    node3->random = NULL;   // Correct: 3->NULL
    
    printf("\nBefore correction - Random pointers:\n");
    printf("Node 1 random -> Node %d\n", node1->random ? node1->random->data : -1);
    printf("Node 2 random -> Node %d (INCORRECT - should point to Node 3)\n", 
           node2->random ? node2->random->data : -1);
    printf("Node 3 random -> %s\n", node3->random ? "node" : "NULL");
    
    // Correct the random pointer
    // In this case, we know node2's random should point to node3
    node2->random = node3;
    
    printf("\nAfter correction - Random pointers:\n");
    printf("Node 1 random -> Node %d\n", node1->random ? node1->random->data : -1);
    printf("Node 2 random -> Node %d (CORRECTED)\n", 
           node2->random ? node2->random->data : -1);
    printf("Node 3 random -> %s\n", node3->random ? "node" : "NULL");
    
    // Free memory
    free(node1);
    free(node2);
    free(node3);
}

// Alternative: General function to detect and correct random pointers
void detectAndCorrectRandom(struct Node* head) {
    if(head == NULL) return;
    
    printf("\nDetecting and correcting random pointers...\n");
    
    struct Node* current = head;
    while(current != NULL) {
        // Check if random pointer is valid (points to a node in the list)
        if(current->random != NULL) {
            struct Node* temp = head;
            int found = 0;
            
            // Verify if random points to a node in the list
            while(temp != NULL) {
                if(temp == current->random) {
                    found = 1;
                    break;
                }
                temp = temp->next;
            }
            
            if(!found) {
                printf("Node %d has invalid random pointer. Correcting...\n", current->data);
                // Correct strategy: point to next node, or NULL if at end
                current->random = current->next;
            }
        }
        current = current->next;
    }
}

void demonstrateGeneralCase() {
    printf("\n=== General Case Demonstration ===\n");
    
    // Create list: 10<->20<->30<->NULL
    struct Node* head = NULL;
    struct Node* n1 = (struct Node*)malloc(sizeof(struct Node));
    struct Node* n2 = (struct Node*)malloc(sizeof(struct Node));
    struct Node* n3 = (struct Node*)malloc(sizeof(struct Node));
    
    n1->data = 10; n2->data = 20; n3->data = 30;
    
    n1->prev = NULL; n1->next = n2;
    n2->prev = n1; n2->next = n3;
    n3->prev = n2; n3->next = NULL;
    
    head = n1;
    
    // Create an invalid random pointer (pointing outside the list)
    struct Node* externalNode = (struct Node*)malloc(sizeof(struct Node));
    externalNode->data = 99;
    externalNode->next = NULL;
    externalNode->prev = NULL;
    
    n2->random = externalNode;  // Invalid: points to external node
    
    printf("Before correction:\n");
    printf("Node 10 random: %s\n", n1->random ? "points to node" : "NULL");
    printf("Node 20 random: points to external node (INVALID)\n");
    printf("Node 30 random: %s\n", n3->random ? "points to node" : "NULL");
    
    // Detect and correct
    detectAndCorrectRandom(head);
    
    printf("After correction:\n");
    printf("Node 10 random: %s\n", n1->random ? "points to node" : "NULL");
    printf("Node 20 random: %s\n", n2->random ? "points to valid node" : "NULL");
    printf("Node 30 random: %s\n", n3->random ? "points to node" : "NULL");
    
    // Cleanup
    free(externalNode);
    free(n1); free(n2); free(n3);
}

int main() {
    correctRandomPointer();
    demonstrateGeneralCase();
    return 0;
}
